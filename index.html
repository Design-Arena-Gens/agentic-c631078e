<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp Agent Dashboard</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 24px; line-height: 1.5; }
    .container { max-width: 880px; margin: 0 auto; }
    h1 { margin: 0 0 8px; }
    .card { border: 1px solid #4443; border-radius: 12px; padding: 16px; margin: 16px 0; }
    .row { display: flex; gap: 12px; }
    .row > * { flex: 1; }
    input, textarea, button { font: inherit; padding: 10px 12px; border-radius: 8px; border: 1px solid #4443; }
    button { cursor: pointer; }
    code, pre { background: #0001; padding: 2px 6px; border-radius: 6px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>WhatsApp Agent</h1>
    <p class="mono">Auto-reply assistant for WhatsApp Business (Cloud API)</p>

    <div class="card" id="statusCard">
      <h3>Status</h3>
      <div id="status"></div>
      <button id="refresh">Refresh</button>
    </div>

    <div class="card">
      <h3>Simulator</h3>
      <div class="row">
        <input id="name" placeholder="Your name (optional)" />
        <input id="message" placeholder="Type a message..." />
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="send">Simulate</button>
      </div>
      <pre id="simOut"></pre>
    </div>

    <div class="card">
      <h3>Webhook Setup (Meta)</h3>
      <ol>
        <li>Set Environment Variables on Vercel: <code>WHATSAPP_VERIFY_TOKEN</code>, <code>WHATSAPP_ACCESS_TOKEN</code>, <code>WHATSAPP_PHONE_NUMBER_ID</code>.</li>
        <li>In Meta Developer Console ? WhatsApp ? Configuration ? Webhook URL:
          <div><code>https://agentic-c631078e.vercel.app/api/webhook</code></div>
        </li>
        <li>Verify token must match <code>WHATSAPP_VERIFY_TOKEN</code>.</li>
      </ol>
      <p>On message, the agent replies with concise, helpful responses. If <code>OPENAI_API_KEY</code> is set, it enhances replies.</p>
    </div>

    <div class="card">
      <h3>Manual Send (cURL)</h3>
      <pre class="mono">curl -X POST \
  https://graph.facebook.com/v21.0/$WHATSAPP_PHONE_NUMBER_ID/messages \
  -H "Authorization: Bearer $WHATSAPP_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "messaging_product":"whatsapp",
    "to":"<USER_PHONE_E164>",
    "type":"text",
    "text": { "body": "Hello from the agent!" }
  }'
</pre>
    </div>
  </div>

  <script>
    async function refreshStatus() {
      try {
        const r = await fetch('/api/status');
        const j = await r.json();
        const s = document.getElementById('status');
        if (!j.ok) { s.textContent = 'Status error'; return; }
        s.innerHTML = `
          <div>WHATSAPP_VERIFY_TOKEN: <b>${j.env.WHATSAPP_VERIFY_TOKEN ? 'set' : 'missing'}</b></div>
          <div>WHATSAPP_ACCESS_TOKEN: <b>${j.env.WHATSAPP_ACCESS_TOKEN ? 'set' : 'missing'}</b></div>
          <div>WHATSAPP_PHONE_NUMBER_ID: <b>${j.env.WHATSAPP_PHONE_NUMBER_ID ? 'set' : 'missing'}</b></div>
          <div>OPENAI_API_KEY: <b>${j.env.OPENAI_API_KEY ? 'set' : 'missing'}</b></div>
        `;
      } catch {
        document.getElementById('status').textContent = 'Failed to fetch status';
      }
    }
    document.getElementById('refresh').addEventListener('click', refreshStatus);
    refreshStatus();

    document.getElementById('send').addEventListener('click', async () => {
      const text = document.getElementById('message').value.trim();
      const name = document.getElementById('name').value.trim();
      if (!text) return;
      const out = document.getElementById('simOut');
      out.textContent = '...';
      try {
        const r = await fetch('/api/simulate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text, name }) });
        const j = await r.json();
        out.textContent = j.ok ? j.reply : JSON.stringify(j);
      } catch (e) {
        out.textContent = 'Request failed';
      }
    });
  </script>
</body>
</html>
